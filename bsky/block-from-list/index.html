<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block from List</title>
    <link rel="icon" type="image/x-icon" href="../../favicon.ico">
    <link href="../../styles.css" rel="stylesheet" type="text/css" media="all">
</head>

<body>
    <h1>Block a List of Users</h1>

    <form id="actorForm">
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <input type="text" id="actorId" name="actorId" placeholder="Handle" required>
            <input type="text" id="appPassword" name="appPassword" placeholder="App Password" required>
            <input type="text" id="listUrl" name="listUrl" placeholder="List link" required>
        </div>
        <br>
        <div style="display: flex; align-items: center; justify-content: center;">
            <button type="button" onclick="blockFromList(event)">Block List</button>
            <!-- <button type="button" onclick="unblockFromList(event)">Unblock List</button> -->
        </div>
        <br>
    </form>

    <pre id="result" style="display: flex; align-items: center; justify-content: center;"></pre>

    <style>
        body {
            padding-right: 15px;
            padding-left: 15px;
        }

        input {
            background-color: #2C2C2C;
            color: white;
            width: 550px;
        }

        button {
            background-color: #2C2C2C;
            color: white;
            width: 125px;
        }

        input:focus {
            border-color: rgb(196, 27, 174);
            outline: none;
        }

        .container {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            gap: 10px;
        }

        .container div {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
            padding-left: 10px;
            padding-right: 10px;
            white-space: normal;
        }

        pre p {
            color: white;
            white-space: normal;
            width: 100%;
        }

        #actorForm ::selection,
        #result ::selection {
            background-color: rgba(73, 73, 73, .8);
            color: inherit;
        }
    </style>

    <script>
        document.getElementById("actorForm").addEventListener("submit", async function (event) {
            event.preventDefault()
            await blockFromList(event)
        })

        async function blockFromList(event) {
            event.preventDefault()
            const actorId = document.getElementById("actorId").value
            if (!actorId) {
                document.getElementById("result").textContent = `Error: no actor entered.`
                return
            }
            const appPassword = document.getElementById("appPassword").value
            if (!appPassword) {
                document.getElementById("result").textContent = `Error: no app password entered.`
                return
            }
            const listUrl = document.getElementById("listUrl").value
            if (!listUrl) {
                document.getElementById("result").textContent = `Error: no list url entered.`
                return
            }

            listUri = await listUrlToUri(listUrl)
            if (!listUri) {
                document.getElementById("result").textContent = `Error retrieving list uri.`
                return
            }
            let didList = await getListItems(listUri)
            if (!didList) {
                document.getElementById("result").textContent = `Error retrieving list items.`
                return
            }

            did = await resolveHandle(actorId)
            if (!did) {
                document.getElementById("result").textContent = `Error resolving handle.`
                return
            }
            console.log(`DID: ${did}`)
            const service = await serviceEndpoint(did)
            if (!service) {
                document.getElementById("result").textContent = `Error retrieving service endpoint.`
                return
            }
            console.log(`Service Endpoint: ${service}`)
            const session = await getSession(actorId, appPassword, service)
            if (!session) {
                document.getElementById("result").textContent = `Error retrieving auth session.`
                return
            }

            const success = await blockDidList(session, service, did, didList)
            if (!success) {
                document.getElementById("result").textContent = `Error blocking DID list.`
                return
            }

            document.getElementById("result").textContent = `List successfully blocked.`
        }

        async function blockDidList(session, service, did, didList) {
            const api = `${service}/xrpc/com.atproto.repo.createRecord`;
            const token = session.accessJwt;

            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': `Bearer ${token}`,
            };

            for (const blockDid of didList) {
                const payload = {
                    repo: did,
                    collection: `app.bsky.graph.block`,
                    record: {
                        createdAt: new Date().toISOString(),
                        subject: blockDid,
                    },
                };

                const response = await fetch(api, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error status: ${response.status}`);
                }
            }

            return true;
        }

        async function getListItems(listUri) {
            const LIMIT = 100
            let cursor = undefined
            const api = 'https://public.api.bsky.app/xrpc/app.bsky.graph.getList'
            let didList = []
            while (true) {
                const res = await fetch(`${api}?list=${listUri}&limit=${LIMIT}&cursor=${cursor}`)
                const data = await res.json()
                if (data.items && data.items.length > 0) {
                    const items = data.items
                    for (let idx = 0; idx < items.length; idx++) {
                        didList.push(items[idx].subject.did);
                    }
                } else {
                    break
                }
                cursor = data.cursor
                if (!cursor) break
            }
            return didList
        }

        async function listUrlToUri(listUrl) {
            const parts = postUrl.replace(/\/$/, '').replace("https://", "").split('/');

            if (parts.length > 5) {
                throw new Error(`Post URL '${postUrl}' has too many segments.`);
            }
            if (parts.length < 5) {
                throw new Error(`Post URL '${postUrl}' does not have enough segments.`);
            }

            const rkey = parts[parts.length - 1];
            const handle = parts[parts.length - 3];

            const did = await resolveHandle(handle)
            if (!did) return undefined

            return `at://${did}/app.bsky.graph.list/${rkey}`;
        }

        async function getSession(username, password) {
            const url = 'https://bsky.social/xrpc/com.atproto.server.createSession'
            const payload = {
                identifier: username,
                password: password,
            }
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                })
                if (!response.ok) {
                    throw new Error(`HTTP error status: ${response.status}`)
                }
                const session = await response.json()
                return session
            } catch (error) {
                console.error('Error creating session:', error)
                throw error
            }
        }

        async function resolveHandle(handle) {
            if (handle.startsWith("did:")) { return handle }
            if (handle.startsWith("@")) { handle = handle.slice(1) }
            const response = await fetch(`https://public.api.bsky.app/xrpc/com.atproto.identity.resolveHandle?handle=${handle}`)
            if (!response.ok) {
                document.getElementById("result").textContent = `Error: failed to resolve DID`
                throw new Error(`Failed to resolve DID: ${await response.text()}`)
            }
            return (await response.json()).did
        }

        async function serviceEndpoint(did) {
            let response
            if (did.startsWith(`did:plc`)) {
                console.log("did:plc")
                response = await fetch(`https://plc.directory/${did}`)
            } else {
                console.log(`did:web`)
                response = await fetch(`https://${did.slice(8)}/.well-known/did.json`)
            }
            console.log(`${did}`)
            if (!response.ok) {
                document.getElementById("result").textContent = `Error: failed to retrieve service endpoint`
                throw new Error(`Failed to retrieve service endpoint: ${await response.text()}`)
            }
            services = (await response.json()).service
            for (const service of services) {
                if (service.type === "AtprotoPersonalDataServer") {
                    return service.serviceEndpoint
                }
            }
            document.getElementById("result").textContent = `PDS serviceEndpoint not found in DID document`
            throw new Error(`PDS serviceEndpoint not found in DID document`)
        }
    </script>
</body>

</html>